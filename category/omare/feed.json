{
    "version": "https://jsonfeed.org/version/1",
    "title": "欢迎 • All posts by \"omare\" category",
    "description": "DESS, THU",
    "home_page_url": "https://ningchenhui.github.io",
    "items": [
        {
            "id": "https://ningchenhui.github.io/ESM/OMARE/CoarsenOperator/",
            "url": "https://ningchenhui.github.io/ESM/OMARE/CoarsenOperator/",
            "title": "OMARE 粗化算子",
            "date_published": "2022-06-22T10:47:52.000Z",
            "content_html": "<p>OMARE CoarsenOperator <span id=\"more\"></span></p>\n<h1 id=\"新增自定义插值算子\"><a class=\"markdownIt-Anchor\" href=\"#新增自定义插值算子\">#</a> 新增自定义插值算子</h1>\n<p>参考  <code>NemoSpaceInterpCenter.h</code>  中的实现。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"><span>NemoSpaceMeanCenter.h</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">NemoSpaceMeanCenter</span> <span class=\"token operator\">:</span> <span class=\"token base-clause\"><span class=\"token keyword\">public</span> xfer<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">CoarsenOperator</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">NDIM</span><span class=\"token operator\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token function\">NemoSpaceMeanCenter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\td_name_id <span class=\"token operator\">=</span> <span class=\"token string\">\"NEMO_MEAN_INTERP\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\talpha <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">//TODO 粗化时细网格值的权重</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   * @brief 在指定的粗网格内，</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   * 将细网格片上指定的数据片插值到粗网格片上指定的数据片上.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   * @param fine 输入参数，Patch 类，表示细网格片.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   * @param coarse 输入参数，Patch 类，表示粗网格片.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   * @param dst_component 输入参数，整型，表示目的数据片.</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   * @param src_component 输入参数，整型，表示源数据片.</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   * @param  coarse_box 输入参数，Box 类，表示粗化网格.</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   * @param ratio 输入参数，整型向量类，表示粗化比率.</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">coarsen</span><span class=\"token punctuation\">(</span>hier<span class=\"token double-colon punctuation\">::</span>Patch<span class=\"token operator\">&lt;</span>NDIM<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> coarse<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> hier<span class=\"token double-colon punctuation\">::</span>Patch<span class=\"token operator\">&lt;</span>NDIM<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> fine<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>               <span class=\"token keyword\">const</span> <span class=\"token keyword\">int</span> dst_component<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">int</span> src_component<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>               <span class=\"token keyword\">const</span> hier<span class=\"token double-colon punctuation\">::</span>Box<span class=\"token operator\">&lt;</span>NDIM<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> coarse_box<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>               <span class=\"token keyword\">const</span> hier<span class=\"token double-colon punctuation\">::</span>IntVector<span class=\"token operator\">&lt;</span>NDIM<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> ratio<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">const</span> hier<span class=\"token double-colon punctuation\">::</span>Box<span class=\"token operator\">&lt;</span>NDIM<span class=\"token operator\">></span> fine_box <span class=\"token operator\">=</span> hier<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Box</span><span class=\"token operator\">&lt;</span>NDIM<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">refine</span><span class=\"token punctuation\">(</span>coarse_box<span class=\"token punctuation\">,</span> ratio<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"><span>NemoFort.h</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">extern</span> <span class=\"token keyword\">void</span> <span class=\"token function\">space_mean_center_</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token operator\">&amp;</span> ir00<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token operator\">&amp;</span> jr00<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token operator\">&amp;</span> ic00<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token operator\">&amp;</span> jc00<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                            <span class=\"token keyword\">int</span><span class=\"token operator\">&amp;</span> ir0<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token operator\">&amp;</span> jr0<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token operator\">&amp;</span> ir1<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token operator\">&amp;</span> jr1<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                            <span class=\"token keyword\">int</span><span class=\"token operator\">&amp;</span> ic0<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token operator\">&amp;</span> jc0<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token operator\">&amp;</span> ic1<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token operator\">&amp;</span> jc1<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                            <span class=\"token keyword\">int</span><span class=\"token operator\">&amp;</span> jpir<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token operator\">&amp;</span> jpjr<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span><span class=\"token operator\">*</span> ur<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                            <span class=\"token keyword\">int</span><span class=\"token operator\">&amp;</span> jpic<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token operator\">&amp;</span> jpjc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span><span class=\"token operator\">*</span> uc<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                            <span class=\"token keyword\">int</span><span class=\"token operator\">*</span> ratio<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h1 id=\"fortran-实现\"><a class=\"markdownIt-Anchor\" href=\"#fortran-实现\">#</a> Fortran 实现</h1>\n<figure class=\"highlight fortran\"><figcaption data-lang=\"fortran\"><span>JASMIN_FILLGHOST.F90</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SUBROUTINE</span> space_mean_center<span class=\"token punctuation\">(</span> ir00<span class=\"token punctuation\">,</span> jr00<span class=\"token punctuation\">,</span> ic00<span class=\"token punctuation\">,</span> jc00<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&amp;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                                ir0<span class=\"token punctuation\">,</span> jr0<span class=\"token punctuation\">,</span> ir1<span class=\"token punctuation\">,</span> jr1<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&amp;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                                ic0<span class=\"token punctuation\">,</span> jc0<span class=\"token punctuation\">,</span> ic1<span class=\"token punctuation\">,</span> jc1<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&amp;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                                jpir<span class=\"token punctuation\">,</span> jpjr<span class=\"token punctuation\">,</span> uf<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&amp;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                                jpic<span class=\"token punctuation\">,</span> jpjc<span class=\"token punctuation\">,</span> uc<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&amp;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                                ratio<span class=\"token punctuation\">)</span> bind<span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> name<span class=\"token operator\">=</span><span class=\"token string\">\"space_mean_center_\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">! input &amp; output            </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">INTEGER</span><span class=\"token punctuation\">,</span>                        <span class=\"token keyword\">INTENT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">in</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">::</span>   ir00<span class=\"token punctuation\">,</span> jr00<span class=\"token punctuation\">,</span> ic00<span class=\"token punctuation\">,</span> jc00      <span class=\"token comment\">!patch lower index (ghost included)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">INTEGER</span><span class=\"token punctuation\">,</span>                        <span class=\"token keyword\">INTENT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">in</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">::</span>   ir0<span class=\"token punctuation\">,</span> jr0<span class=\"token punctuation\">,</span> ir1<span class=\"token punctuation\">,</span> jr1          <span class=\"token comment\">!refine box start/end index</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">INTEGER</span><span class=\"token punctuation\">,</span>                        <span class=\"token keyword\">INTENT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">in</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">::</span>   ic0<span class=\"token punctuation\">,</span> jc0<span class=\"token punctuation\">,</span> ic1<span class=\"token punctuation\">,</span> jc1          <span class=\"token comment\">!coarse box start/end index</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">INTEGER</span><span class=\"token punctuation\">,</span>                        <span class=\"token keyword\">INTENT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">in</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">::</span>   jpir<span class=\"token punctuation\">,</span> jpjr                  <span class=\"token comment\">!refine patch size (ghost included)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">REAL</span><span class=\"token punctuation\">(</span>wp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">DIMENSION</span><span class=\"token punctuation\">(</span>jpir<span class=\"token punctuation\">,</span>jpjr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">INTENT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">in</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">::</span>   uf                          <span class=\"token comment\">!refine patch data</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">INTEGER</span><span class=\"token punctuation\">,</span>                        <span class=\"token keyword\">INTENT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">in</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">::</span>   jpic<span class=\"token punctuation\">,</span> jpjc                  <span class=\"token comment\">!coarse patch size (ghost included)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">REAL</span><span class=\"token punctuation\">(</span>wp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">DIMENSION</span><span class=\"token punctuation\">(</span>jpic<span class=\"token punctuation\">,</span>jpjc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">INTENT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">inout</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">::</span>   uc                       <span class=\"token comment\">!coarse patch data</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">INTEGER</span><span class=\"token punctuation\">,</span>  <span class=\"token keyword\">DIMENSION</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>         <span class=\"token keyword\">INTENT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">in</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">::</span>   ratio                       <span class=\"token comment\">!x refinement ratio NDIM?</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">! local</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">INTEGER</span> <span class=\"token operator\">::</span> ic<span class=\"token punctuation\">,</span> jc</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">INTEGER</span> <span class=\"token operator\">::</span> ic_loc<span class=\"token punctuation\">,</span> jc_loc</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">REAL</span><span class=\"token punctuation\">(</span>wp<span class=\"token punctuation\">)</span> <span class=\"token operator\">::</span> sum_</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">DO</span> jc <span class=\"token operator\">=</span> jc0<span class=\"token punctuation\">,</span> jc1</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">DO</span> ic <span class=\"token operator\">=</span> ic0<span class=\"token punctuation\">,</span> ic1</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        sum_ <span class=\"token operator\">=</span> SUM<span class=\"token punctuation\">(</span>uf<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ic<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span>ratio<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">1</span> <span class=\"token operator\">-</span>ir00<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span>ic<span class=\"token operator\">*</span>ratio<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span>ir00<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>jc<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span>ratio<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">1</span> <span class=\"token operator\">-</span>jr00<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span>jc<span class=\"token operator\">*</span>ratio<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span>jr00<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token comment\">! coarse local index</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        ic_loc <span class=\"token operator\">=</span> ic <span class=\"token operator\">-</span> ic00 <span class=\"token operator\">+</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        jc_loc <span class=\"token operator\">=</span> jc <span class=\"token operator\">-</span> jc00 <span class=\"token operator\">+</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        uc<span class=\"token punctuation\">(</span>ic_loc<span class=\"token punctuation\">,</span> jc_loc<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> sum_ <span class=\"token operator\">/</span> <span class=\"token keyword\">REAL</span><span class=\"token punctuation\">(</span>ratio<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span>ratio<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>wp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">ENDDO</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">ENDDO</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token keyword\">END SUBROUTINE</span> space_mean_center</pre></td></tr></table></figure><h1 id=\"启用-overlay\"><a class=\"markdownIt-Anchor\" href=\"#启用-overlay\">#</a> 启用 Overlay</h1>\n<p>这里  <code>sync_time % 1 != 0</code>  的  <code>1</code>  改为 Overlay 的步长。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"><span>NemoLevelIntegrator_body.C Producer.py</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/****************************************************************</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * AMR, 同步粗网格层.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> *****************************************************************/</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">void</span> NemoLevelIntegrator<span class=\"token operator\">::</span><span class=\"token function\">synchronizeCoarserLevel</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">const</span> JASMIN<span class=\"token operator\">::</span>tbox<span class=\"token operator\">::</span>Pointer<span class=\"token operator\">&lt;</span>JASMIN<span class=\"token operator\">::</span>hier<span class=\"token operator\">::</span>BasePatchHierarchy<span class=\"token operator\">&lt;</span>NDIM<span class=\"token operator\">>></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    hierarchy<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token keyword\">int</span> finer_level_number<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">double</span> sync_time<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token keyword\">double</span> coarser_old_time<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  using namespace std<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  using namespace JASMIN<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>sync_time <span class=\"token operator\">%</span> <span class=\"token number\">1</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  tbox<span class=\"token operator\">::</span>pout<span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">\"***********************************************\"</span><span class=\"token operator\">&lt;&lt;</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  tbox<span class=\"token operator\">::</span>pout<span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">\"Synchronize (Overlay) Coarser Level... \"</span><span class=\"token operator\">&lt;&lt;</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  tbox<span class=\"token operator\">::</span>pout<span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">\"     finer_level_number==\"</span><span class=\"token operator\">&lt;&lt;</span>finer_level_number<span class=\"token operator\">&lt;&lt;</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  tbox<span class=\"token operator\">::</span>pout<span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">\"     sync_time==\"</span><span class=\"token operator\">&lt;&lt;</span>sync_time<span class=\"token operator\">&lt;&lt;</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  tbox<span class=\"token operator\">::</span>pout<span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">\"     coarser_old_time==\"</span><span class=\"token operator\">&lt;&lt;</span>coarser_old_time<span class=\"token operator\">&lt;&lt;</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  tbox<span class=\"token operator\">::</span>pout<span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">\"***********************************************\"</span><span class=\"token operator\">&lt;&lt;</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token comment\">// 校正相邻粗网格层的通量</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  tbox<span class=\"token operator\">::</span>Pointer<span class=\"token operator\">&lt;</span>hier<span class=\"token operator\">::</span>PatchLevel<span class=\"token operator\">&lt;</span>NDIM<span class=\"token operator\">>></span> finer_level <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    hierarchy<span class=\"token operator\">-></span><span class=\"token function\">getPatchLevel</span><span class=\"token punctuation\">(</span>finer_level_number<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  tbox<span class=\"token operator\">::</span>Pointer<span class=\"token operator\">&lt;</span>hier<span class=\"token operator\">::</span>PatchLevel<span class=\"token operator\">&lt;</span>NDIM<span class=\"token operator\">>></span> coarser_level <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    hierarchy<span class=\"token operator\">-></span><span class=\"token function\">getPatchLevel</span><span class=\"token punctuation\">(</span>finer_level_number <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token keyword\">double</span> actual_dt <span class=\"token operator\">=</span> sync_time <span class=\"token operator\">-</span> coarser_old_time<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token comment\">// 细网格 -> 粗网格 (具体方法在初始化构件中)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  sync_overlay_intc<span class=\"token operator\">-></span><span class=\"token function\">synchronizeCoarserLevel</span><span class=\"token punctuation\">(</span>finer_level<span class=\"token punctuation\">,</span> sync_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"注册使用插值算子的变量\"><a class=\"markdownIt-Anchor\" href=\"#注册使用插值算子的变量\">#</a> 注册使用插值算子的变量</h1>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>Producer.py var_db.py</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>OVERLAY_DOUBLE_INTERP_CENTER <span class=\"token operator\">=</span> <span class=\"token string\">\"NEMO_MEAN_INTERP\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>t_field_list <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token string\">\"tsn\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"tsb\"</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token string\">\"sshn\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"sshb\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token string\">\"avm_k\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Overlayregister.h\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"w\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\"># T</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token keyword\">for</span> field <span class=\"token keyword\">in</span> t_field_list<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">\"intc->registerCoarsenPatchData(manager->\"</span><span class=\"token operator\">+</span>field<span class=\"token operator\">+</span><span class=\"token string\">\"_id,\\n\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">\"                        \\\"\"</span><span class=\"token operator\">+</span>OVERLAY_DOUBLE_INTERP_CENTER<span class=\"token operator\">+</span><span class=\"token string\">\"\\\",\\n\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">\"                        manager->\"</span><span class=\"token operator\">+</span>field<span class=\"token operator\">+</span><span class=\"token string\">\"_id);\\n\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight c\"><figcaption data-lang=\"c\"><span>main_Nemo.C</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"NemoSpaceMeanCenter.h\"</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// add user-define sapce refine operator</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>tbox<span class=\"token operator\">::</span>Pointer<span class=\"token operator\">&lt;</span>JASMIN<span class=\"token operator\">::</span>pdat<span class=\"token operator\">::</span>NemoSpaceMeanCenter<span class=\"token operator\">></span> nemo_space_mean_center_operator</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token operator\">=</span> new JASMIN<span class=\"token operator\">::</span>pdat<span class=\"token operator\">::</span><span class=\"token function\">NemoSpaceMeanCenter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>grid_geometry<span class=\"token operator\">-></span><span class=\"token function\">addSpatialCoarsenOperator</span><span class=\"token punctuation\">(</span>nemo_space_mean_center_operator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h1 id=\"与-conservative_coarsen-比较\"><a class=\"markdownIt-Anchor\" href=\"#与-conservative_coarsen-比较\">#</a> 与 “CONSERVATIVE_COARSEN” 比较</h1>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>h5diff omare_mean/build/exp_l2/javis_dump.00006/processor_cluster.00000.jasmin omare_220608/build/exp_l2/javis_dump.00006/processor_cluster.00000.jasmin</pre></td></tr></table></figure><pre><code>size:           [2400]           [2400]\nposition        sshn            sshn            difference          \n------------------------------------------------------------\n[ 900 ]          6.04414e-07     6.04414e-07     5.68434e-14    \n1 differences found\ndataset: &lt;/processor.00000/level.00001/patch.00000/un.38&gt; and &lt;/processor.00000/level.00001/patch.00000/un.38&gt;\nsize:           [15000]           [15000]\nposition        un.38           un.38           difference          \n------------------------------------------------------------\n[ 145 ]          -1.00591e-05    -1.00591e-05    9.09495e-13    \n[ 210 ]          -1.2723e-06     -1.2723e-06     1.13687e-13    \n[ 1985 ]          -8.53e-07       -8.53e-07       5.68434e-14    \n[ 2438 ]          -1.50793e-05    -1.50793e-05    9.09495e-13    \n</code></pre>\n<p>加上  <code>1e-10</code>  的限制后只有 14 个差异值。</p>\n<h2 id=\"sshn\"><a class=\"markdownIt-Anchor\" href=\"#sshn\">#</a> sshn</h2>\n<p class=\"gallery\" data-height=\"400\"><img data-src=\"0608.png\" alt=\"\" title=\"jasmin\"><br>\n<img data-src=\"mean.png\" alt=\"mean\"><br>\n<img data-src=\"bug.png\" alt=\"赋0\"></p>\n",
            "tags": [
                "Memo",
                "Coding"
            ]
        },
        {
            "id": "https://ningchenhui.github.io/ESM/OMARE/omare220205/",
            "url": "https://ningchenhui.github.io/ESM/OMARE/omare220205/",
            "title": "OMARE 学习使用（一）",
            "date_published": "2022-02-05T11:19:13.000Z",
            "content_html": "<p>Learn to run OMARE（i）<span id=\"more\"></span></p>\n<p>step 1 - 解压源代码后，在目录里创建  <code>build</code>  文件夹<br>\n step 2 - 修改文件中的路径</p>\n<pre><code>a. CMakeLists.txt\n  set(JASMIN_VERSION 新路径)\nb. input/GYRE/namelist_cfg (之后可以在build中改)\n  nn_GYRE  resolution\n</code></pre>\n<p>step 3 - 进入  <code>build</code>  文件夹，执行  <code>~/jasmin4/bin/cmake ../</code> <br>\nstep 4 - 执行  <code>make</code>  ( <code>make -j 50</code>  多线程)<br>\nstep 5 -  <code>./main2d ../input/nemo-2d.input</code>   运行不完 / 测试时可  <code>ctrl+c</code>  中止<br>\n step 6 -  <code>ctrl+r</code>   <code>teravap</code>  查看数据 （ <code>/usr/local/teravap/teravap2_2_0.linux- x86_64/bin/teravap</code> ）<br>\n         数据在  <code>./build/javis../dumps.javis</code>  中，打开后 Add - Mesh , Draw。更换数据需要重启。</p>\n<p>修改完 h 文件后执行 step 4</p>\n<p>虚拟机 mpi 运行</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mpirun -n <span class=\"token number\">4</span> ./main2d <span class=\"token punctuation\">..</span>/input/nemo-2d.input</pre></td></tr></table></figure>",
            "tags": [
                "Memo",
                "Coding"
            ]
        }
    ]
}